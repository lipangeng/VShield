# VShield + OAuth2-Proxy + Basic Auth (dual auth for register/admin)
#
# Goal:
# - Browser users: authenticate via oauth2-proxy (auth_request)
# - CLI users: authenticate via HTTP Basic Auth
# - Either one is enough (satisfy any)

http {
    js_path "/etc/nginx/njs/";
    js_import VShield from VShield.js;

    # Required by VShield.js
    js_shared_dict_zone zone=vs_ip:1M timeout=2h;

    upstream app_backend {
        server 127.0.0.1:8081;
    }

    upstream oauth2_proxy {
        server 127.0.0.1:4180;
    }

    server {
        listen 80;
        server_name _;

        # oauth2-proxy endpoints (same host)
        location /oauth2/ {
            proxy_pass http://oauth2_proxy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Auth-Request-Redirect $request_uri;
        }

        # auth_request endpoint used by protected locations
        location = /oauth2/auth {
            internal;
            proxy_pass http://oauth2_proxy;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Uri $request_uri;
            proxy_set_header Content-Length "";
            proxy_pass_request_body off;
        }

        # Redirect to oauth2 login if auth_request returns 401
        error_page 401 = /oauth2/sign_in;

        # Application protected by IP whitelist
        location /secure/ {
            auth_request /validate;
            proxy_pass http://app_backend;
        }

        location = /validate {
            internal;
            js_content VShield.http_verify;
        }

        # --- Dual-auth zones ---
        # Browser: OAuth2 session via auth_request
        # CLI: Basic auth via auth_basic + auth_basic_user_file
        # satisfy any = either OAuth2 OR Basic is accepted

        location = /register {
            satisfy any;
            auth_request /oauth2/auth;
            auth_basic "VShield Register";
            auth_basic_user_file /etc/nginx/vshield.htpasswd;

            js_content VShield.register;
        }

        location = /cancel {
            satisfy any;
            auth_request /oauth2/auth;
            auth_basic "VShield Register";
            auth_basic_user_file /etc/nginx/vshield.htpasswd;

            js_content VShield.cancel;
        }

        location = /admin/whitelist {
            satisfy any;
            auth_request /oauth2/auth;
            auth_basic "VShield Admin";
            auth_basic_user_file /etc/nginx/vshield.htpasswd;

            js_content VShield.adminWhiteList;
        }

        location = /admin/register {
            satisfy any;
            auth_request /oauth2/auth;
            auth_basic "VShield Admin";
            auth_basic_user_file /etc/nginx/vshield.htpasswd;

            js_content VShield.adminRegister;
        }

        location = /admin/cancel {
            satisfy any;
            auth_request /oauth2/auth;
            auth_basic "VShield Admin";
            auth_basic_user_file /etc/nginx/vshield.htpasswd;

            js_content VShield.adminCancel;
        }
    }
}
